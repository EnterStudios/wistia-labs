// Generated by CoffeeScript 1.6.3
var VideoInEmail,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

VideoInEmail = (function() {
  function VideoInEmail() {
    this.outputVideoCode = __bind(this.outputVideoCode, this);
    this.updateVideoCode = __bind(this.updateVideoCode, this);
    this.updatePreview = __bind(this.updatePreview, this);
    this.updateOutput = __bind(this.updateOutput, this);
    var _this = this;
    this.exampleEmbedCode = "<iframe src=\"//fast.wistia.net/embed/iframe/7phpe910v3\" allowtransparency=\"true\" frameborder=\"0\" scrolling=\"no\" class=\"wistia_embed\" name=\"wistia_embed\" allowfullscreen mozallowfullscreen webkitallowfullscreen oallowfullscreen msallowfullscreen width=\"600\" height=\"338\"></iframe>";
    $("#source_embed_code").on('keyup', function() {
      _this.updateEmbedCodes();
      return _this.debounceUpdates();
    });
    $("#video_width").on('keyup', function() {
      return _this.debounceUpdates();
    });
    $("#video_width").on('change', function() {
      return _this.debounceUpdates();
    });
    $("#fallback_link").on('keyup', function() {
      return _this.debounceUpdates();
    });
    $("a[name=remove_all]").on('click', function(e) {
      e.preventDefault();
      return _this.clearAll();
    });
    $("a[name=see_example]").on('click', function(e) {
      e.preventDefault();
      return _this.setupExample();
    });
    $("a[name=reset]").on('click', function(e) {
      e.preventDefault();
      return _this.debounceUpdates();
    });
  }

  VideoInEmail.prototype.updateEmbedCodes = function() {
    this.previewEmbedCode = Wistia.EmbedCode.parse($("#source_embed_code").val());
    return this.sourceEmbedCode = Wistia.EmbedCode.parse($("#source_embed_code").val());
  };

  VideoInEmail.prototype.setupExample = function() {
    $("#source_embed_code").val(this.exampleEmbedCode);
    $("#video_width").val(600);
    $("#fallback_link").val("http://wistia.com");
    this.updateEmbedCodes();
    return this.debounceUpdates();
  };

  VideoInEmail.prototype.clearAll = function() {
    $("#source_embed_code").val("");
    this.updateEmbedCodes();
    return this.debounceUpdates();
  };

  VideoInEmail.prototype.debounceUpdates = function() {
    clearTimeout(this._updateOutputTimeout);
    return this._updateOutputTimeout = setTimeout(this.updateOutput, 100);
  };

  VideoInEmail.prototype.updateOutput = function() {
    if (this.sourceEmbedCode && this.sourceEmbedCode.isValid()) {
      this.width = this.getVideoWidth();
      this.updateVideoCode();
      return this.updatePreview();
    } else {
      $("#video_code").val("Please enter a valid Wistia embed code.");
      return $("#preview").html("<div id=\"placeholder_preview\">Your video here</div>");
    }
  };

  VideoInEmail.prototype.updatePreview = function() {
    var _this = this;
    if (this.previewEmbedCode.width() === this.getVideoWidth() && this.previewLive) {
      return;
    }
    return this.previewEmbedCode.width(this.getVideoWidth()).height(this.getVideoHeight()).previewInElem("preview", {
      type: "api"
    }, function() {
      return _this.previewLive = true;
    });
  };

  VideoInEmail.prototype.updateVideoCode = function() {
    var hashedId,
      _this = this;
    hashedId = Wistia.EmbedCode.parse($("#source_embed_code").val()).hashedId();
    return Wistia.remote.media(hashedId, function(media) {
      var mp4Url, playerColor, posterUrl, styles;
      mp4Url = media.assets.iphone.url.replace('.bin', '/video.mp4');
      posterUrl = media.assets.still.url;
      playerColor = media.embed_options.playerColor;
      $('#video_code').val(_this.outputVideoCode(posterUrl, mp4Url, posterUrl, playerColor));
      styles = {
        height: '200px',
        width: '585px',
        'font-family': 'Courier'
      };
      return $('#video_code').css(styles);
    });
  };

  VideoInEmail.prototype.outputVideoCode = function(poster, mp4, fallbackImage, playerColor) {
    return "<video width=\"" + (this.getVideoWidth()) + "\" height=\"" + (this.getVideoHeight()) + "\" poster=\"" + poster + "\" controls=\"controls\">\n  <source src=\"" + mp4 + "\" type=\"video/mp4\"/>\n  <a href=\"" + (this.getFallbackLink()) + "\"><img src=\"" + (fallbackImage.replace('.bin', '.jpg')) + "?image_play_button=true&image_play_button_color=" + playerColor + "&image_resize=" + (this.getVideoWidth()) + "\" width=\"" + (this.getVideoWidth()) + "\" height=\"" + (this.getVideoHeight()) + "\"/></a>\n</video>";
  };

  VideoInEmail.prototype.getVideoWidth = function() {
    return parseInt($("#video_width").val());
  };

  VideoInEmail.prototype.getVideoHeight = function() {
    var aspect;
    aspect = this.sourceEmbedCode.width() / this.sourceEmbedCode.height();
    return Math.round(this.getVideoWidth() / aspect);
  };

  VideoInEmail.prototype.getFallbackLink = function() {
    return $("#fallback_link").val();
  };

  return VideoInEmail;

})();

window.setupLabInterface = function($) {
  return $(function() {
    window.videoInEmail = new VideoInEmail();
    if (!Wistia.localStorage("videoInEmail.cleared")) {
      showExample();
      $(".show_example_text").hide();
      $(".clear_example_text").show();
    } else {
      $(".show_example_text").show();
      $(".clear_example_text").hide();
    }
    $("#clear_example").click(function(event) {
      event.preventDefault();
      resetInterface();
      $(".show_example_text").show();
      $(".clear_example_text").hide();
      return Wistia.localStorage("videoInEmail.cleared", true);
    });
    return $("#show_example").click(function(event) {
      event.preventDefault();
      showExample();
      $(".show_example_text").hide();
      $(".clear_example_text").show();
      return Wistia.localStorage("videoInEmail.cleared", false);
    });
  });
};

window.resetInterface = function() {
  return videoInEmail.clearAll();
};

window.showExample = function() {
  return videoInEmail.setupExample();
};

setupLabInterface(jQuery);
